<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet">
</head>
<body>
    <div class="nav">
        <a href="/config">âš™ Configuration</a>
    </div>
    <h1>{{ heading }}</h1>
    <p class="subtitle">Simulated conveyor belt inspection system</p>
    <div class="camera-grid">
        {% for key, cam in cameras.items() %}
        <div class="camera-card">
            <div class="camera-header">
                <span>{{ cam.label }}</span>
                <span class="topic">{{ cam.topic }}</span>
            </div>
            <div class="camera-feed">
                <video id="video-{{ key }}" class="video-js vjs-default-skin" autoplay muted playsinline></video>
            </div>
            <div class="camera-description">{{ cam.description }}</div>
        </div>
        {% endfor %}
    </div>

    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <script>
        // Initialize video.js for each camera
        const cameras = {{ cameras.keys() | list | tojson }};
        const players = {};

        cameras.forEach(camera => {
            const player = videojs(`video-${camera}`, {
                autoplay: true,
                muted: true,
                controls: true,
                fluid: true,
                liveui: true,
                html5: {
                    vhs: {
                        overrideNative: true
                    }
                }
            });

            player.src({
                src: `/video/${camera}`,
                type: 'video/mp4'
            });

            // Auto-retry on error
            let retryCount = 0;
            player.on('error', function() {
                if (retryCount < 3) {
                    retryCount++;
                    console.log(`${camera}: Retrying... (${retryCount}/3)`);
                    setTimeout(() => {
                        player.src({ src: `/video/${camera}`, type: 'video/mp4' });
                        player.load();
                        player.play();
                    }, 2000);
                } else {
                    console.error(`${camera}: Stream failed after 3 retries`);
                }
            });

            player.on('playing', () => {
                retryCount = 0; // Reset on success
            });

            players[camera] = player;
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            Object.values(players).forEach(p => p.dispose());
        });
    </script>
</body>
</html>
